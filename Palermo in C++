#include <iostream>
#include <vector>
#include <map>
#include <algorithm>
#include <random>
#include <ctime>
#include <set>
#include <locale>
#include <windows.h>

struct Player {
    std::string name;
    std::string role;
    bool alive = true;
};

std::vector<Player> players;
int maxMafia = 2;
int maxCops = 2;
int numCitizens;
int totalPlayers;

std::random_device rd;
std::mt19937 rng(rd());

bool isNameUnique(const std::string& name) {
    for (const auto& p : players)
        if (p.name == name)
            return false;
    return true;
}

void setupPlayers() {
    std::cout << "Î ÏŒÏƒÎ¿Î¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ Î¸Î± Ï€Î±Î¯Î¾Î¿Ï…Î½; ";
    std::cin >> totalPlayers;
    while (totalPlayers < (maxMafia + maxCops + 1)) {
        std::cout << "Î§ÏÎµÎ¹Î¬Î¶Î¿Î½Ï„Î±Î¹ Ï„Î¿Ï…Î»Î¬Ï‡Î¹ÏƒÏ„Î¿Î½ " << (maxMafia + maxCops + 1) << " Ï€Î±Î¯ÎºÏ„ÎµÏ‚.\nÎ”ÏŽÏƒÎµ Î¾Î±Î½Î¬: ";
        std::cin >> totalPlayers;
    }

    players.clear();
    std::set<std::string> usedNames;
    std::string name;

    std::cin.ignore(); // Clear input buffer
    for (int i = 0; i < totalPlayers; ++i) {
        std::cout << "ÎŒÎ½Î¿Î¼Î± Ï€Î±Î¯ÎºÏ„Î· " << i + 1 << ": ";
        std::getline(std::cin, name);
        while (!isNameUnique(name)) {
            std::cout << "Î¤Î¿ ÏŒÎ½Î¿Î¼Î± Ï…Ï€Î¬ÏÏ‡ÎµÎ¹ Î®Î´Î·. Î”ÏŽÏƒÎµ Î¬Î»Î»Î¿: ";
            std::getline(std::cin, name);
        }
        players.push_back({name, "", true});
    }

    numCitizens = totalPlayers - maxMafia - maxCops;
}

void assignRoles() {
    std::vector<std::string> roles;

    for (int i = 0; i < maxMafia; ++i) roles.push_back("Î”Î¿Î»Î¿Ï†ÏŒÎ½Î¿Ï‚");
    for (int i = 0; i < maxCops; ++i) roles.push_back("Î‘ÏƒÏ„Ï…Î½Î¿Î¼Î¹ÎºÏŒÏ‚");
    for (int i = 0; i < numCitizens; ++i) roles.push_back("Î Î¿Î»Î¯Ï„Î·Ï‚");

    std::shuffle(roles.begin(), roles.end(), rng);

    for (size_t i = 0; i < players.size(); ++i) {
        players[i].role = roles[i];
    }

    std::cout << "\nÎŸÎ¹ ÏÏŒÎ»Î¿Î¹ Î±Î½Î±Ï„Î­Î¸Î·ÎºÎ±Î½. ÎŸ ÎºÎ±Î¸Î­Î½Î±Ï‚ Î²Î»Î­Ï€ÎµÎ¹ Î¼Ï…ÏƒÏ„Î¹ÎºÎ¬ Ï„Î¿Î½ ÏÏŒÎ»Î¿ Ï„Î¿Ï…:\n";
    for (const auto& p : players) {
        std::cout << p.name << ", Ï€Î¬Ï„Î± Enter Î³Î¹Î± Î½Î± Î´ÎµÎ¹Ï‚ Ï„Î¿Î½ ÏÏŒÎ»Î¿ ÏƒÎ¿Ï…...";
        std::cin.get();
        std::cout << "ÎŸ ÏÏŒÎ»Î¿Ï‚ ÏƒÎ¿Ï… ÎµÎ¯Î½Î±Î¹: " << p.role << "\n";
        std::cout << "(Ï€Î¬Ï„Î± Enter Î³Î¹Î± Î½Î± ÏƒÏ…Î½ÎµÏ‡Î¯ÏƒÎµÎ¹ Î¿ ÎµÏ€ÏŒÎ¼ÎµÎ½Î¿Ï‚)\n";
        std::cin.get();
        std::system("clear || cls");
    }
}

int findPlayerIndexByName(const std::string& name) {
    for (size_t i = 0; i < players.size(); ++i) {
        if (players[i].name == name && players[i].alive)
            return i;
    }
    return -1;
}

void nightPhase() {
    std::cout << "\nðŸŒ™ ÎÏÏ‡Ï„Î± Ï€Î­Ï†Ï„ÎµÎ¹ ÏƒÏ„Î¿ Ï‡Ï‰ÏÎ¹ÏŒ...\n";
    std::vector<std::string> mafiaNames;
    for (const auto& p : players)
        if (p.alive && p.role == "Î”Î¿Î»Î¿Ï†ÏŒÎ½Î¿Ï‚")
            mafiaNames.push_back(p.name);

    std::cout << "ÎŸÎ¹ Î´Î¿Î»Î¿Ï†ÏŒÎ½Î¿Î¹ (" << mafiaNames.size() << ") Î±Ï€Î¿Ï†Î±ÏƒÎ¯Î¶Î¿Ï…Î½ Ï€Î¿Î¹Î¿Î½ Î½Î± ÏƒÎºÎ¿Ï„ÏŽÏƒÎ¿Ï…Î½:\n";
    for (const auto& name : mafiaNames) {
        std::string victim;
        int victimIndex = -1;
        do {
            std::cout << name << ", Ï€Î¿Î¹Î¿Î½ Î¸ÎµÏ‚ Î½Î± ÏƒÎºÎ¿Ï„ÏŽÏƒÎµÎ¹Ï‚; ";
            std::getline(std::cin, victim);
            victimIndex = findPlayerIndexByName(victim);
        } while (victimIndex == -1 || players[victimIndex].role == "Î”Î¿Î»Î¿Ï†ÏŒÎ½Î¿Ï‚" || !players[victimIndex].alive);

        players[victimIndex].alive = false;
        std::cout << "ÎŸ Ï€Î±Î¯ÎºÏ„Î·Ï‚ " << players[victimIndex].name << " ÏƒÎºÎ¿Ï„ÏŽÎ¸Î·ÎºÎµ Î¼Î­ÏƒÎ± ÏƒÏ„Î· Î½ÏÏ‡Ï„Î±!\n";
        break; // Î¼ÏŒÎ½Î¿ Î­Î½Î±Ï‚ ÏƒÎºÎ¿Ï„ÏŽÎ½ÎµÏ„Î±Î¹
    }
}

void dayPhase() {
    std::cout << "\nâ˜€ï¸ ÎœÎ­ÏÎ± Î¾Î·Î¼Î­ÏÏ‰ÏƒÎµ ÏƒÏ„Î¿ Ï‡Ï‰ÏÎ¹ÏŒ...\nÎŸÎ¹ Ï€Î±Î¯ÎºÏ„ÎµÏ‚ ÏƒÏ…Î¶Î·Ï„Î¿ÏÎ½ ÎºÎ±Î¹ ÏˆÎ·Ï†Î¯Î¶Î¿Ï…Î½ Ï€Î¿Î¹Î¿Î½ Î½Î± Î´Î¹ÏŽÎ¾Î¿Ï…Î½:\n";
    std::map<std::string, int> voteCounts;

    for (const auto& p : players) {
        if (!p.alive) continue;
        std::string vote;
        int voteIndex = -1;
        do {
            std::cout << p.name << ", Ï€Î¿Î¹Î¿Î½ ÏˆÎ·Ï†Î¯Î¶ÎµÎ¹Ï‚; ";
            std::getline(std::cin, vote);
            voteIndex = findPlayerIndexByName(vote);
        } while (voteIndex == -1 || !players[voteIndex].alive || vote == p.name);

        voteCounts[vote]++;
    }

    // Î’ÏÎµÏ‚ Ï„Î¿Î½ Ï€Î±Î¯ÎºÏ„Î· Î¼Îµ Ï„Î¹Ï‚ Ï€ÎµÏÎ¹ÏƒÏƒÏŒÏ„ÎµÏÎµÏ‚ ÏˆÎ®Ï†Î¿Ï…Ï‚
    std::string eliminated = "";
    int maxVotes = 0;
    for (const auto& pair : voteCounts) {
        if (pair.second > maxVotes) {
            maxVotes = pair.second;
            eliminated = pair.first;
        }
    }

    if (eliminated != "") {
        int idx = findPlayerIndexByName(eliminated);
        players[idx].alive = false;
        std::cout << "\nÎŸ Ï€Î±Î¯ÎºÏ„Î·Ï‚ " << eliminated << " Î±Ï€Î¿Ï‡ÏŽÏÎ·ÏƒÎµ Î±Ï€ÏŒ Ï„Î¿ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹!\n";
    } else {
        std::cout << "Î™ÏƒÎ¿ÏˆÎ·Ï†Î¯Î±! ÎšÎ±Î½ÎµÎ¯Ï‚ Î´ÎµÎ½ Ï†ÎµÏÎ³ÎµÎ¹ ÏƒÎ®Î¼ÎµÏÎ±.\n";
    }
}

bool checkVictory() {
    int mafia = 0, others = 0;
    for (const auto& p : players) {
        if (!p.alive) continue;
        if (p.role == "Î”Î¿Î»Î¿Ï†ÏŒÎ½Î¿Ï‚") mafia++;
        else others++;
    }

    if (mafia == 0) {
        std::cout << "\nðŸŽ‰ ÎŸÎ¹ Ï€Î¿Î»Î¯Ï„ÎµÏ‚ ÎºÎ­ÏÎ´Î¹ÏƒÎ±Î½! ÎŸÎ¹ Î´Î¿Î»Î¿Ï†ÏŒÎ½Î¿Î¹ ÎµÎ¾Î¿Î½Ï„ÏŽÎ¸Î·ÎºÎ±Î½!\n";
        return true;
    }
    if (mafia >= others) {
        std::cout << "\nðŸ’€ ÎŸÎ¹ Î´Î¿Î»Î¿Ï†ÏŒÎ½Î¿Î¹ ÎºÎ­ÏÎ´Î¹ÏƒÎ±Î½! Î•Ï€Î¹ÎºÏÎ¬Ï„Î·ÏƒÎ±Î½ ÏƒÏ„Î¿ Ï‡Ï‰ÏÎ¹ÏŒ!\n";
        return true;
    }
    return false;
}

int main() {
    // Î˜Î­Ï„ÎµÎ¹ Ï„Î·Î½ ÎºÎ¿Î½ÏƒÏŒÎ»Î± ÏƒÎµ UTF-8 mode
    SetConsoleOutputCP(CP_UTF8);
    SetConsoleCP(CP_UTF8); // Î“Î¹Î± ÏƒÏ‰ÏƒÏ„Î® ÎµÎ¹ÏƒÎ±Î³Ï‰Î³Î® string Î±Ï€ÏŒ cin


    std::srand(time(nullptr));
    std::cout << "ðŸŽ­ ÎšÎ±Î»ÏŽÏ‚ Î®ÏÎ¸ÎµÏ‚ ÏƒÏ„Î¿ Î´Î¹Î±Î´ÏÎ±ÏƒÏ„Î¹ÎºÏŒ Ï€Î±Î¹Ï‡Î½Î¯Î´Î¹ ÎœÎ¬Ï†Î¹Î±!\n";
    setupPlayers();
    assignRoles();

    bool gameOver = false;
    while (!gameOver) {
        nightPhase();
        if ((gameOver = checkVictory())) break;
        dayPhase();
        if ((gameOver = checkVictory())) break;
    }

    std::cout << "\nðŸŽ® Î¤Î­Î»Î¿Ï‚ Ï€Î±Î¹Ï‡Î½Î¹Î´Î¹Î¿Ï!\n";
    return 0;
}
